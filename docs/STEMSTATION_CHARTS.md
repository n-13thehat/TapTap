# STEMSTATION Charts & MIDI Import

This game now prefers pre-authored charts over generated patterns. If a chart exists for a track, it will be loaded automatically; otherwise the fallback generator is used.

## Where charts live

- Path: `app/stemstation/charts/<trackId>.json`
- The client calls `/api/stemstation/chart?trackId=<trackId>&difficulty=<difficulty>` and consumes the JSON.
- If a chart file is missing, gameplay falls back to the generator.
- Filenames are sanitized (`[^a-zA-Z0-9_-]+` → `_`) to avoid path issues; the loader tries both raw trackId and sanitized name.

## Chart JSON schema

```json
{
  "songId": "track-id",
  "title": "Song Title",
  "artist": "Artist",
  "bpm": 140,
  "offsetMs": 0,
  "difficulty": "expert",
  "notes": [
    { "timeMs": 1200, "lane": 0, "type": "tap" },
    { "timeMs": 1800, "lane": 2, "type": "hold", "endTimeMs": 2600 }
  ]
}
```

- `timeMs` / `endTimeMs` are milliseconds from song start (offset applied in the JSON).
- `lane` is 0–3 (left to right).
- `type` is `tap` or `hold` (add more types later if needed).

## Converting MIDI → chart JSON (optional workflow)

You can convert a MIDI to the chart format offline. One simple approach:

1) Install a MIDI parser (example): `pnpm add -D @tonejs/midi`
2) Create a tiny script (example):

```ts
// tools/midi-to-chart.ts
import { Midi } from "@tonejs/midi";
import fs from "fs";

const midiPath = process.argv[2];
const trackId = process.argv[3] || "demo-track";
const difficulty = process.argv[4] || "normal";
const offsetMs = Number(process.argv[5] || 0);

if (!midiPath) throw new Error("Usage: tsx tools/midi-to-chart.ts <file.mid> [trackId] [difficulty] [offsetMs]");

const data = fs.readFileSync(midiPath);
const midi = new Midi(data);
const bpm = midi.header.tempos[0]?.bpm || 120;
const notes: any[] = [];

// Flatten all midi tracks; map pitches to lanes 0-3
const laneFor = (midiNote: number) => Math.max(0, Math.min(3, Math.floor((midiNote - 36) / 12)));

midi.tracks.forEach((t) => {
  t.notes.forEach((n) => {
    const timeMs = Math.round(n.time * 1000) + offsetMs;
    const endTimeMs = Math.round(n.time * 1000 + n.duration * 1000) + offsetMs;
    notes.push({
      timeMs,
      lane: laneFor(n.midi),
      type: n.duration > 0.25 ? "hold" : "tap",
      endTimeMs: n.duration > 0.25 ? endTimeMs : undefined,
    });
  });
});

const chart = { songId: trackId, title: trackId, artist: "Unknown", bpm, offsetMs, difficulty, notes: notes.sort((a, b) => a.timeMs - b.timeMs) };

fs.writeFileSync(`app/stemstation/charts/${trackId}.json`, JSON.stringify(chart, null, 2));
console.log("Chart written to", `app/stemstation/charts/${trackId}.json`);
```

Run it (with tsx or node + ts-node):

```
pnpm dlx tsx tools/midi-to-chart.ts path/to/file.mid my-track expert 0
```

You can swap the lane mapping logic to match your stems/pitches.

## Generate fallback charts for bundled STEMSTATION songs

If you want autogenerated charts for the local STEMSTATION library (MP3s under `app/stemstation/Music For The Future -vx9`):

```
pnpm dlx tsx tools/generate-local-charts.ts
```

This writes charts to `app/stemstation/charts/<sanitized-track-id>.json` so the game can use them even without MIDI. Each file includes notes for all difficulties (tap+hold).

## Convert chart → MIDI (for DAW preview)

To preview a chart in your DAW, convert a chart JSON to MIDI:

```
pnpm dlx tsx tools/chart-to-midi.ts <trackId> [outDir]
```

This reads `app/stemstation/charts/<trackId>.json` and writes `<trackId>.mid` (default: `app/stemstation/midi/`). Lanes map to a musical range (C3/E3/G3/C4) so you can hear the patterns.

## Transcribe audio → MIDI/Chart with basic-pitch (Python)

If you have Python 3.10 + TensorFlow-compatible env, you can use Spotify’s basic-pitch to generate MIDI and a chart from audio:

```
python3 tools/transcribe-basicpitch.py app/stemstation/Music\\ For\\ The\\ Future\\ -vx9/2Horns.mp3 local:0:2Horns.mp3 expert 0
```

Requirements:
- Python 3.10 (basic-pitch needs TF < 2.15; wheels aren’t available for Py3.12)
- pip install basic-pitch==0.4.0 pretty_midi

Outputs:
- `app/stemstation/midi/<sanitized-trackId>.mid`
- `app/stemstation/charts/<sanitized-trackId>.json`

If basic-pitch isn’t available, use `tools/midi-to-chart.ts` after you obtain a MIDI from another source, or fall back to `tools/generate-local-charts.ts`.

## Runtime behavior

- If `app/stemstation/charts/<trackId>.json` exists and has notes, the gameplay uses those notes (plus the in-game user offset slider).
- If missing or invalid, the generator builds a beat-aligned pattern as before.

## Quick checklist

- Chart file present at `app/stemstation/charts/<trackId>.json`.
- Notes array populated; lanes 0–3; `timeMs`/`endTimeMs` in ms.
- BPM/offsetMs set to match the audio.
